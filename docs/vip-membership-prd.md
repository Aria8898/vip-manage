# VIP 状态查询系统需求文档（V1.0）

## 1. 项目目标

构建一套面向管理员与用户的 VIP 会员状态系统：

- 管理员端强调高效操作与精确对账（快、准）。
- 用户端通过专属链接免登录查看会员状态与变动记录。

## 2. 角色与权限

| 角色 | 权限 |
| --- | --- |
| 管理员 | 登录后台、创建用户、搜索用户、充值、重置 Token、查看审计 |
| 用户 | 通过专属链接查看自己的会员状态和历史记录 |

## 3. 功能需求

### 3.1 管理端（Admin Console）

#### 3.1.1 用户管理（核心）

1. 添加用户
   - 输入用户备注名（例如：微信名-大刘）。
   - 系统自动生成专属访问 Token。
2. 用户搜索
   - 支持按备注名检索。
   - 支持按用户 ID 检索。
3. 专属链接分发
   - 用户列表每行提供“复制链接”按钮。
   - 链接格式：`http://vip.yourdomain.com/status?t={token}`。
4. 一键充值
   - 天数输入：正整数（例如 30）。
   - 原因选择：微信支付、支付宝支付、活动赠送、售后补偿、手动修正。
   - 支持内部备注（仅管理员可见，用于记录转账单号等）。
   - 充值逻辑：
     - 未过期：在当前到期时间基础上累加。
     - 已过期：从充值操作当刻开始计时。

#### 3.1.2 账目审计（对账用）

1. 今日概览
   - 今日充值总次数。
   - 今日累计送出总天数。
2. 充值流水表
   - 字段包含：时间、用户、变动天数、变动后到期时间、操作原因、内部备注、操作管理员。

#### 3.1.3 运维工具

1. 重置 Token
   - 生成新 Token。
   - 旧 Token 立即失效。
   - 记录操作日志。

### 3.2 用户端（User View）

#### 3.2.1 状态看板

1. 欢迎语
   - 显示：`你好，[备注名]`。
2. 会员状态
   - 有效：绿色高亮“VIP 会员中”。
   - 过期：灰色或红色提示“会员已过期”。
3. 时间数据
   - 剩余时长：大字号显示“剩余 XX 天”。
   - 截止日期：小字号显示“有效期至：YYYY-MM-DD 23:59”。
4. 续费提醒
   - 剩余天数小于 3 天时，天数标红提醒。

#### 3.2.2 变动历史

1. 透明记录
   - 以列表或时间轴按时间倒序展示变动记录。
   - 示例：`2026-02-28 | 微信支付购买 | +30天`。

## 4. 系统核心逻辑

| 逻辑点 | 规则 |
| --- | --- |
| 到期判断 | `status = (expire_at > now) ? "有效" : "过期"` |
| 充值逻辑 | `new_expire_at = max(expire_at, now) + recharge_days` |
| 链接安全 | Token 必须为高熵长随机字符串（建议 UUID v4 或 32 位以上随机值） |
| 时区统一 | 统一按 UTC+8（北京时间）进行计算与展示 |

## 5. 安全与审计要求

1. 管理后台必须启用登录保护（强密码）。
2. 建议支持会话过期与登录失败限流。
3. 用户端仅允许按 Token 查看对应用户信息，禁止越权访问。
4. Token 不可预测，禁止使用可枚举规则。
5. 关键操作写入审计日志：新增用户、充值、重置 Token。

## 6. 数据结构建议（MVP）

### 6.1 `users`

- `id`
- `username`
- `token`
- `expire_at`
- `created_at`
- `updated_at`

### 6.2 `recharge_records`

- `id`
- `user_id`
- `change_days`
- `reason`
- `internal_note`
- `expire_before`
- `expire_after`
- `operator_admin_id`
- `created_at`

### 6.3 `admin_users`

- `id`
- `username`
- `password_hash`
- `last_login_at`
- `created_at`

### 6.4 `token_reset_logs`

- `id`
- `user_id`
- `old_token_hash`
- `new_token_hash`
- `operator_admin_id`
- `created_at`

## 7. 验收标准（UAT）

1. 新增用户后可立即复制专属链接并正常访问。
2. 充值在“未过期”和“已过期”场景下计算均正确。
3. 今日概览统计与流水明细汇总一致。
4. 重置 Token 后旧链接失效，新链接可用。
5. 用户端状态、剩余天数、到期时间与时区显示正确。
6. 剩余天数小于 3 天时触发红色提醒样式。
7. 未登录管理员无法访问管理端页面与接口。

## 8. 版本范围建议

1. V1（MVP）
   - 管理员登录、用户管理、专属链接、充值、流水、Token 重置、用户状态页。
2. V1.1
   - 对账导出、审计筛选、批量充值能力。
