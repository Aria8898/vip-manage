# VIP 状态查询系统开发计划（V1）

## 1. 文档信息

- 版本：V1.0
- 日期：2026-02-28
- 依据文档：
  - `docs/vip-membership-prd.md`
  - `docs/vip-membership-tech-stack.md`

## 2. 计划目标

在 6 个阶段内完成 MVP 到可上线版本，每个阶段均提供可演示的实际效果，避免“只完成代码、看不到成果”。

## 3. 阶段划分总览

| 阶段 | 预计周期 | 目标摘要 | 阶段可见效果 |
| --- | --- | --- | --- |
| P0 基础搭建 | 第 1 周（前半） | Monorepo、D1、前后端基础链路打通 | 页面可打开，API 健康检查可用，数据库完成初始化 |
| P1 鉴权闭环 | 第 1 周（后半） | 管理员登录/退出、鉴权中间件、未登录拦截 | 后台可真实登录，未登录访问被拒绝 |
| P2 用户管理 | 第 2 周（前半） | 新增用户、搜索用户、复制专属链接 | 可新增用户并复制链接访问用户页 |
| P3 充值与审计 | 第 2 周（后半） | 充值逻辑、流水记录、今日概览 | 充值后到期时间变化可见，统计与流水一致 |
| P4 用户端完善 | 第 3 周（前半） | 状态看板、历史记录、Token 重置 | 用户可查看剩余天数和历史，重置后旧链失效 |
| P5 安全与上线 | 第 3 周（后半） | 限流、安全头、UAT、部署 | 安全策略可验证，UAT 通过并可发布 |

## 4. 分阶段执行计划

### P0 基础搭建（第 1 周前半）

**目标**

- 建立可持续开发的工程骨架和环境基线。

**主要开发项**

1. 初始化 `pnpm workspace` 与基础目录（`shared/backend/frontend`）。
2. 建立 `shared` 类型包（API 响应结构、核心 DTO、枚举）。
3. 配置 Worker 项目、D1 绑定、首版 migration（`users`、`recharge_records`、`admin_users`、`token_reset_logs`）。
4. 建立前端基础路由（`/admin`、`/status/:token`）和 API 客户端基础封装。
5. 增加 `GET /api/health` 健康检查接口。

**可见效果（演示）**

1. 打开前端可看到管理端和用户端基础页面（壳页面）。
2. 访问 `/api/health` 返回 `code=0`。
3. D1 中可查询到 4 张核心表。

**阶段验收标准**

- 本地与测试环境可一键启动前后端。
- migration 可重复执行且无破坏性错误。

**交付物**

- Monorepo 初始代码。
- 首版数据库 schema 与迁移脚本。
- 环境变量模板与启动说明。

### P1 鉴权闭环（第 1 周后半）

**目标**

- 先完成管理后台访问控制，确保后续功能开发在受保护环境内进行。

**主要开发项**

1. 实现 `POST /api/admin/login`、`POST /api/admin/logout`。
2. 使用 JWT + HttpOnly Cookie 实现会话。
3. 编写管理端鉴权中间件（接口 + 页面路由守卫）。
4. 加入登录失败限流（初版）。
5. 初始化管理员账号导入脚本（含密码 hash）。

**可见效果（演示）**

1. 管理员可成功登录并进入后台。
2. 退出后再次访问管理接口返回 401。
3. 连续错误登录触发限制（429 或明确错误提示）。

**阶段验收标准**

- 未登录无法访问任一管理端写接口。
- Cookie 具备 `HttpOnly`、`Secure`、`SameSite` 策略。

**交付物**

- 鉴权 API 与中间件。
- 后台登录页和基础会话管理。
- 登录安全策略配置。

### P2 用户管理（第 2 周前半）

**目标**

- 完成管理员核心操作：建用户、查用户、发专属链接。

**主要开发项**

1. `POST /api/admin/users`：新增用户并生成高熵 Token。
2. `GET /api/admin/users?query=`：按备注名/ID 检索。
3. 用户列表页（AntD Table）+ 创建用户弹窗。
4. 列表行增加“复制链接”功能，支持 `/status/:token`（兼容 `?t=`）。
5. 数据库存储 token hash，避免明文 token 落库。

**可见效果（演示）**

1. 新增用户后列表立即可见。
2. 搜索备注名或 ID 可快速定位。
3. 点击复制后，浏览器打开链接即可进入该用户状态页。

**阶段验收标准**

- PRD 中“新增用户、搜索用户、分发链接”能力完整可用。
- Token 不可预测、不可枚举，库内仅保存 hash。

**交付物**

- 用户管理 API 与页面。
- Token 生成与 hash 存储实现。
- 链接分发交互流程。

### P3 充值与审计（第 2 周后半）

**目标**

- 打通最关键业务闭环：充值计算正确、流水可审计、统计可对账。

**主要开发项**

1. `POST /api/admin/users/:id/recharge`：
   - 使用原子更新实现 `max(expire_at, now) + days * 86400`。
   - 记录 `expire_before`、`expire_after`、`reason`、`internal_note`。
2. `GET /api/admin/recharge-records`：充值流水列表（倒序）。
3. `GET /api/admin/dashboard/today`：今日次数与送出总天数。
4. 管理端充值弹窗、流水页面、今日概览卡片。
5. 关键单元测试：未过期累加、已过期重启、边界时间（UTC+8 展示）。

**可见效果（演示）**

1. 对同一用户充值后，到期时间实时更新。
2. 流水可看到“充值前/后到期时间”和操作人。
3. 今日概览与流水汇总结果一致。

**阶段验收标准**

- PRD 充值逻辑在两类场景下均正确。
- 数据一致性满足对账要求。

**交付物**

- 充值与审计 API。
- 管理端充值和对账页面。
- 充值核心测试用例。

### P4 用户端完善（第 3 周前半）

**目标**

- 完成用户侧核心体验和运维侧 Token 重置能力。

**主要开发项**

1. `GET /api/status/:token`：返回状态、剩余天数、到期时间、历史记录。
2. 用户端状态卡片（有效/过期态、剩余天数高亮、UTC+8 格式）。
3. 剩余天数 `< 3` 的红色提醒样式。
4. 历史记录列表或时间轴（倒序）。
5. `POST /api/admin/users/:id/reset-token` + `token_reset_logs` 记录。

**可见效果（演示）**

1. 用户通过专属链接可看到“你好，[备注名]”、剩余天数、到期时间。
2. 临近过期用户显示红色提醒。
3. 管理端重置 Token 后，旧链接立即失效，新链接可访问。

**阶段验收标准**

- PRD 用户端状态与变动历史要求全部覆盖。
- Token 重置具备可追溯日志。

**交付物**

- 用户端完整页面。
- 状态查询 API 与历史数据接口。
- Token 重置与日志能力。

### P5 安全加固、UAT 与上线（第 3 周后半）

**目标**

- 完成上线前安全加固与验收闭环，形成可发布版本。

**主要开发项**

1. 接入限流策略：
   - `/api/status/*`：60 req/min/IP
   - `/api/admin/login`：10 req/10min/IP
   - 管理写接口：120 req/min/管理员
2. 增加安全响应头：
   - `Referrer-Policy: no-referrer`
   - `Cache-Control: private, no-store`
   - `X-Content-Type-Options: nosniff`
3. 补齐关键审计日志（新增用户、充值、重置 Token）。
4. 按 PRD 第 7 节执行 UAT 7 条验收。
5. 发布到 Cloudflare Pages + Workers，完成生产配置核对。

**可见效果（演示）**

1. 压测或模拟请求可触发限流响应。
2. 响应头在浏览器和接口调试工具中可见。
3. UAT 报告显示全部通过并可在线访问。

**阶段验收标准**

- PRD 验收标准 1-7 全部通过。
- 发布后核心链路可用：登录、建用户、充值、查状态、重置 Token。

**交付物**

- 可上线版本与部署配置。
- UAT 报告与回归清单。
- 上线回滚方案（版本回退与配置回退）。

## 5. 并行协作建议

1. 后端优先推进 P0-P3，前端在 P1 后并行跟进页面。
2. `shared` 类型包每阶段先更新，再联调，避免接口定义漂移。
3. 每个阶段结束固定进行一次“功能演示 + 验收打勾”，未通过项不得进入下一阶段。

## 6. 风险与应对

| 风险 | 影响 | 应对策略 |
| --- | --- | --- |
| D1 并发更新导致到期时间冲突 | 充值结果不一致 | 坚持原子 SQL + 事务批处理；必要时加乐观锁重试 |
| 时区处理不统一 | 用户显示与后台统计不一致 | 存储统一 Unix 秒，展示统一 UTC+8 |
| Token 泄露或可枚举 | 用户信息越权 | 高熵 token + hash 落库 + 限流 + 重置机制 |
| 需求变更插入 | 排期被打乱 | 变更统一进入下一阶段，紧急变更走评审 |

## 7. 阶段验收清单（执行版）

- [ ] P0 验收通过
- [ ] P1 验收通过
- [ ] P2 验收通过
- [ ] P3 验收通过
- [ ] P4 验收通过
- [ ] P5 验收通过

